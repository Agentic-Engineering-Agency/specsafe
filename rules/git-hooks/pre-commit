#!/bin/bash
# SpecSafe v0.4.0 Pre-Commit Hook
# OpenSpec-Style Workflow Validation
# https://github.com/luci-efe/specsafe

echo "üîç Running SpecSafe pre-commit validation..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track exit code
EXIT_CODE=0

# ============================================
# Check 1: PROJECT_STATE.md exists
# ============================================
if [ ! -f "PROJECT_STATE.md" ]; then
    echo -e "${RED}‚ùå PROJECT_STATE.md not found${NC}"
    echo "   Run 'specsafe init' to set up your project"
    exit 1
fi

echo -e "${GREEN}‚úì PROJECT_STATE.md exists${NC}"

# ============================================
# Check 2: Verify spec references in commits
# ============================================
echo ""
echo "üìã Checking for spec references in staged files..."

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null)

# Check for TODO markers mentioning specs in staged files
TODO_SPEC_FILES=$(echo "$STAGED_FILES" | xargs -I {} grep -l "TODO.*spec" {} 2>/dev/null | head -5)

if [ -n "$TODO_SPEC_FILES" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Found TODO items mentioning specs:${NC}"
    echo "$TODO_SPEC_FILES" | while read -r file; do
        echo "   - $file"
    done
    echo "   Review before committing"
    EXIT_CODE=1
fi

# ============================================
# Check 3: Validate staged specs are valid
# ============================================
echo ""
echo "üìÑ Validating staged spec files..."

STAGED_SPECS=$(echo "$STAGED_FILES" | grep -E "^specs/(active|drafts)/SPEC-[0-9]{8}-[0-9]{3}\.md$" 2>/dev/null)

if [ -n "$STAGED_SPECS" ]; then
    echo "$STAGED_SPECS" | while read -r specfile; do
        # Check for required sections
        if ! grep -q "^## 1. Purpose" "$specfile" 2>/dev/null && \
           ! grep -q "^## Problem Statement" "$specfile" 2>/dev/null; then
            echo -e "${YELLOW}‚ö†Ô∏è  $specfile missing Purpose or Problem Statement section${NC}"
        fi
        
        # Check for Status field
        if ! grep -q "Status:" "$specfile" 2>/dev/null; then
            echo -e "${YELLOW}‚ö†Ô∏è  $specfile missing Status field${NC}"
        fi
        
        echo -e "${GREEN}‚úì $specfile structure valid${NC}"
    done
fi

# ============================================
# Check 4: Verify implementation files reference specs
# ============================================
echo ""
echo "üíª Checking implementation files for spec references..."

STAGED_CODE=$(echo "$STAGED_FILES" | grep -E "\.(ts|js|tsx|jsx|py|rs|go|java|kt|swift)$" 2>/dev/null)

if [ -n "$STAGED_CODE" ]; then
    # Check if code files have spec references in comments
    MISSING_REFS=$(echo "$STAGED_CODE" | while read -r file; do
        if ! grep -qE "(SPEC-[0-9]{8}-[0-9]{3}|Refs:|Related spec)" "$file" 2>/dev/null; then
            echo "$file"
        fi
    done)
    
    if [ -n "$MISSING_REFS" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Some code files lack spec references:${NC}"
        echo "$MISSING_REFS" | head -5 | while read -r file; do
            echo "   - $file"
        done
        echo -e "${YELLOW}   Consider adding: // Refs: SPEC-YYYYMMDD-NNN${NC}"
    fi
fi

# ============================================
# Check 5: Test file existence for CODE stage specs
# ============================================
echo ""
echo "üß™ Checking test coverage for CODE stage specs..."

# Get specs in CODE stage from PROJECT_STATE.md
CODE_SPECS=$(grep -E "^- \[ \] .*Status: CODE" PROJECT_STATE.md 2>/dev/null | grep -oE "SPEC-[0-9]{8}-[0-9]{3}")

if [ -n "$CODE_SPECS" ]; then
    while read -r spec_id; do
        # Look for corresponding test directory
        if [ ! -d "src/__tests__/$spec_id" ] && [ ! -d "tests/$spec_id" ]; then
            echo -e "${YELLOW}‚ö†Ô∏è  $spec_id is in CODE stage but no tests found${NC}"
            echo "   Expected: src/__tests__/$spec_id/ or tests/$spec_id/"
            EXIT_CODE=1
        fi
    done <<< "$CODE_SPECS"
fi

# ============================================
# Check 6: Run tests if verify stage detected
# ============================================
echo ""
echo "üî¨ Checking for test execution requirements..."

# Check if any specs are in VERIFY-triggering changes
if [ -f "specsafe.config.json" ]; then
    AUTO_VERIFY=$(grep -o '"autoVerify".*true' specsafe.config.json 2>/dev/null)
    
    if [ -n "$AUTO_VERIFY" ]; then
        echo "Running quick test validation..."
        
        # Run tests if package.json exists and has test script
        if [ -f "package.json" ] && grep -q '"test"' package.json; then
            npm test -- --passWithNoTests --silent 2>/dev/null
            TEST_EXIT=$?
            
            if [ $TEST_EXIT -ne 0 ]; then
                echo -e "${RED}‚ùå Tests failed. Fix before committing.${NC}"
                EXIT_CODE=1
            else
                echo -e "${GREEN}‚úì Tests passing${NC}"
            fi
        fi
    fi
fi

# ============================================
# Summary
# ============================================
echo ""
echo "========================================"

if [ $EXIT_CODE -eq 0 ]; then
    echo -e "${GREEN}‚úÖ SpecSafe pre-commit checks passed${NC}"
    echo "   Ready to commit! üöÄ"
else
    echo -e "${YELLOW}‚ö†Ô∏è  SpecSafe pre-commit warnings found${NC}"
    echo "   Review warnings above before committing"
    echo "   Use --no-verify to bypass (not recommended)"
fi

echo "========================================"

exit $EXIT_CODE
