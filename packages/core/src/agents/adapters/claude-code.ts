/**
 * Claude Code Adapter
 * Generates configuration for Claude Code (Anthropic)
 */

import { BaseAgentAdapter } from './base.js';
import type { AgentDefinition, GeneratedFile, GenerateOptions } from '../types.js';
import { getRequiredAgentDefinition } from '../registry.js';

export class ClaudeCodeAdapter extends BaseAgentAdapter {
  readonly agent: AgentDefinition = getRequiredAgentDefinition('claude-code');

  async generateConfig(projectDir: string, options?: GenerateOptions): Promise<GeneratedFile[]> {
    const files: GeneratedFile[] = [];

    // Generate CLAUDE.md
    files.push({
      path: 'CLAUDE.md',
      content: `# SpecSafe Project - Claude Code Configuration

${this.getMainContext()}

## Claude Code Skills

This project includes Claude Code skills for slash commands:
${this.getWorkflowCommands().map((cmd) => `- /${cmd} - ${this.getCommandDescription(cmd)}`).join('\n')}

## Usage

Use slash commands to navigate the SpecSafe workflow:
1. \`/specsafe\` - Check project status
2. \`/specsafe-explore\` - Start exploration for new features
3. \`/specsafe-new\` - Create a new spec
4. Follow the workflow through test-create, test-apply, verify, and done

## File Organization

my-project/
├── specs/
│   ├── drafts/          # PRD stage specs
│   ├── active/          # In-progress specs
│   ├── archive/         # Completed specs
│   └── exploration/     # Research notes
├── src/
│   └── __tests__/       # Test files organized by spec
├── PROJECT_STATE.md     # Central status tracker
└── CLAUDE.md           # This file

## Commit Message Format

type(SPEC-ID): brief description

Types: feat, fix, test, docs, refactor, chore
Example: feat(SPEC-20260212-001): add user authentication

---
*Generated by SpecSafe v1.0*
`,
    });

    return files;
  }

  async generateCommands(projectDir: string, options?: GenerateOptions): Promise<GeneratedFile[]> {
    const files: GeneratedFile[] = [];

    // Generate skill files for each command
    for (const command of this.getWorkflowCommands()) {
      const skillContent = this.generateSkillFile(command);
      files.push({
        path: `.claude/skills/${command}/SKILL.md`,
        content: skillContent,
      });
    }

    return files;
  }

  private generateSkillFile(command: string): string {
    const description = this.getCommandDescription(command);
    const prompt = this.getCommandPrompt(command);

    // Special handling for specsafe (main status command)
    if (command === 'specsafe') {
      return `---
name: specsafe
description: ${description}
disable-model-invocation: true
---

${prompt}

Read PROJECT_STATE.md to determine current state and provide actionable guidance.
`;
    }

    // Commands with arguments
    const commandsWithArgs = ['specsafe-spec', 'specsafe-test-create', 'specsafe-test-apply', 'specsafe-verify', 'specsafe-done'];
    const hasArgs = commandsWithArgs.includes(command);

    return `---
name: ${command}
description: ${description}${hasArgs ? '\nargument-hint: "[spec-id]"' : ''}
disable-model-invocation: true
---

${prompt}
`;
  }

  getInstructions(): string {
    return `Claude Code Setup Complete!

Files created:
- CLAUDE.md - Main project context
- .claude/skills/ - Slash command skills

## Usage

1. Open your project with Claude Code
2. Use slash commands to navigate the workflow:
   - /specsafe - Check status
   - /specsafe-explore - Start exploration
   - /specsafe-new - Create spec
   - /specsafe-test-create - Generate tests
   - /specsafe-test-apply - Implement
   - /specsafe-verify - Run tests
   - /specsafe-done - Complete spec

The skills will guide you through the entire spec-driven development workflow.
`;
  }
}
