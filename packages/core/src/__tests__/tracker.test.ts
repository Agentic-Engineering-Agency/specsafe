/**
 * ProjectTracker Tests
 * Tests for the SpecSafe Project State Tracker
 */

import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { mkdtemp, rm, writeFile, readFile } from 'fs/promises';
import { tmpdir } from 'os';
import { join } from 'path';
import { ProjectTracker } from '../tracker.js';
import type { Spec } from '../types.js';

describe('ProjectTracker', () => {
  let tempDir: string;
  let tracker: ProjectTracker;

  beforeEach(async () => {
    tempDir = await mkdtemp(join(tmpdir(), 'specsafe-test-'));
    tracker = new ProjectTracker(tempDir);
  });

  afterEach(async () => {
    await rm(tempDir, { recursive: true, force: true });
  });

  describe('initialize', () => {
    it('should create PROJECT_STATE.md with correct structure', async () => {
      await tracker.initialize('Test Project');
      
      const content = await readFile(join(tempDir, 'PROJECT_STATE.md'), 'utf-8');
      expect(content).toContain('# Test Project - Project State');
      expect(content).toContain('**Version:** 1.0.0');
      expect(content).toContain('Total Specs');
      expect(content).toContain('Completion Rate');
      expect(content).toContain('Avg Cycle Time');
      expect(content).toContain('No specs yet');
    });
  });

  describe('readState', () => {
    it('should return null when file does not exist', async () => {
      const state = await tracker.readState();
      expect(state).toBeNull();
    });

    it('should parse existing PROJECT_STATE.md correctly', async () => {
      const markdown = `# Test Project - Project State

**Version:** 1.0.0  
**Last Updated:** 2024-01-15

---

## ðŸ“Š Metrics

| Metric | Value |
|--------|-------|
| Total Specs | 2 |
| Completion Rate | 50.0% |
| Avg Cycle Time | 3.5 days |

### By Stage

| Stage | Count | Percentage |
|-------|-------|------------|
| SPEC | 1 | 50.0% |
| TEST | 0 | 0.0% |
| CODE | 0 | 0.0% |
| QA | 0 | 0.0% |
| COMPLETE | 1 | 50.0% |
| ARCHIVED | 0 | 0.0% |

---

## ðŸ“‹ Active Specs

| ID | Name | Stage | Progress | Last Updated |
|----|------|-------|----------|--------------|
| SPEC-20240115-001 | First Spec | SPEC | 20% | 2024-01-15 |
| SPEC-20240115-002 | Completed Spec | COMPLETE | 100% | 2024-01-14 |

---

*This file is auto-generated by SpecSafe*
`;
      await writeFile(join(tempDir, 'PROJECT_STATE.md'), markdown, 'utf-8');
      
      const state = await tracker.readState();
      expect(state).not.toBeNull();
      expect(state?.projectName).toBe('Test Project');
      expect(state?.version).toBe('1.0.0');
      expect(state?.specs).toHaveLength(2);
      expect(state?.specs[0].id).toBe('SPEC-20240115-001');
      expect(state?.specs[0].stage).toBe('spec');
      expect(state?.specs[1].id).toBe('SPEC-20240115-002');
      expect(state?.specs[1].stage).toBe('complete');
      expect(state?.metrics.totalSpecs).toBe(2);
      expect(state?.metrics.completionRate).toBe(0.5);
    });
  });

  describe('addSpec', () => {
    it('should add new spec and update metrics', async () => {
      await tracker.initialize('Test Project');
      
      const spec: Spec = {
        id: 'SPEC-20240115-001',
        name: 'New Spec',
        description: 'A new specification',
        stage: 'spec',
        createdAt: new Date('2024-01-15'),
        updatedAt: new Date('2024-01-15'),
        requirements: [],
        testFiles: [],
        implementationFiles: [],
        metadata: { author: 'John', project: 'Test', tags: [] }
      };
      
      await tracker.addSpec(spec);
      
      const state = await tracker.readState();
      expect(state?.specs).toHaveLength(1);
      expect(state?.specs[0].id).toBe('SPEC-20240115-001');
      expect(state?.specs[0].name).toBe('New Spec');
      expect(state?.metrics.totalSpecs).toBe(1);
      expect(state?.metrics.byStage.spec).toBe(1);
    });

    it('should update existing spec by ID', async () => {
      await tracker.initialize('Test Project');
      
      const spec1: Spec = {
        id: 'SPEC-20240115-001',
        name: 'Original Name',
        description: 'Original',
        stage: 'spec',
        createdAt: new Date('2024-01-15'),
        updatedAt: new Date('2024-01-15'),
        requirements: [],
        testFiles: [],
        implementationFiles: [],
        metadata: { author: 'John', project: 'Test', tags: [] }
      };
      
      await tracker.addSpec(spec1);
      
      const spec2: Spec = {
        id: 'SPEC-20240115-001',
        name: 'Updated Name',
        description: 'Updated',
        stage: 'test',
        createdAt: new Date('2024-01-15'),
        updatedAt: new Date('2024-01-16'),
        requirements: [{ id: 'REQ-1', text: 'Req', priority: 'P1', scenarios: [] }],
        testFiles: [],
        implementationFiles: [],
        metadata: { author: 'John', project: 'Test', tags: [] }
      };
      
      await tracker.addSpec(spec2);
      
      const state = await tracker.readState();
      expect(state?.specs).toHaveLength(1);
      expect(state?.specs[0].name).toBe('Updated Name');
      expect(state?.specs[0].stage).toBe('test');
    });
  });

  describe('Round-trip', () => {
    it('should preserve data through write â†’ read cycle', async () => {
      await tracker.initialize('Round-trip Test');
      
      const spec: Spec = {
        id: 'SPEC-20240115-001',
        name: 'Round-trip Spec',
        description: 'Testing round-trip',
        stage: 'code',
        createdAt: new Date('2024-01-10'),
        updatedAt: new Date('2024-01-15'),
        requirements: [],
        testFiles: ['test.ts'],
        implementationFiles: ['impl.ts'],
        metadata: { author: 'Tester', project: 'Test', tags: ['round-trip'] }
      };
      
      await tracker.addSpec(spec);
      
      const state = await tracker.readState();
      expect(state?.projectName).toBe('Round-trip Test');
      expect(state?.specs[0].id).toBe('SPEC-20240115-001');
      expect(state?.specs[0].name).toBe('Round-trip Spec');
      expect(state?.specs[0].stage).toBe('code');
      expect(state?.specs[0].progress).toBe(60);
    });
  });

  describe('parseMarkdown', () => {
    it('should handle empty specs table', async () => {
      const markdown = `# Empty Project - Project State

**Version:** 1.0.0  
**Last Updated:** 2024-01-15

---

## ðŸ“Š Metrics

| Metric | Value |
|--------|-------|
| Total Specs | 0 |
| Completion Rate | 0.0% |
| Avg Cycle Time | 0.0 days |

### By Stage

| Stage | Count | Percentage |
|-------|-------|------------|
| SPEC | 0 | 0.0% |
| TEST | 0 | 0.0% |
| CODE | 0 | 0.0% |
| QA | 0 | 0.0% |
| COMPLETE | 0 | 0.0% |
| ARCHIVED | 0 | 0.0% |

---

## ðŸ“‹ Active Specs

No specs yet.

---

*This file is auto-generated by SpecSafe*
`;
      await writeFile(join(tempDir, 'PROJECT_STATE.md'), markdown, 'utf-8');
      
      const state = await tracker.readState();
      expect(state?.specs).toHaveLength(0);
      expect(state?.metrics.totalSpecs).toBe(0);
    });

    it('should handle malformed content gracefully', async () => {
      // Write a file that doesn't match expected spec table patterns
      // The parser will still extract what it can from the markdown
      await writeFile(join(tempDir, 'PROJECT_STATE.md'), 'This is not valid markdown for a project state', 'utf-8');
      
      // The parser should handle this - the implementation falls back to defaults
      // when it can't parse specific values
      const state = await tracker.readState();
      // The file exists and parser tries its best - returns a state with defaults
      expect(state).not.toBeNull();
      expect(state?.projectName).toBe('Untitled Project');
      expect(state?.specs).toEqual([]);
    });
  });

  describe('Metrics calculation', () => {
    it('should calculate byStage counts correctly', async () => {
      await tracker.initialize('Metrics Test');
      
      const specs: Spec[] = [
        { id: 'SPEC-20240115-001', name: 'Spec 1', description: '', stage: 'spec', createdAt: new Date(), updatedAt: new Date(), requirements: [], testFiles: [], implementationFiles: [], metadata: { author: '', project: '', tags: [] } },
        { id: 'SPEC-20240115-002', name: 'Spec 2', description: '', stage: 'spec', createdAt: new Date(), updatedAt: new Date(), requirements: [], testFiles: [], implementationFiles: [], metadata: { author: '', project: '', tags: [] } },
        { id: 'SPEC-20240115-003', name: 'Spec 3', description: '', stage: 'test', createdAt: new Date(), updatedAt: new Date(), requirements: [], testFiles: [], implementationFiles: [], metadata: { author: '', project: '', tags: [] } },
        { id: 'SPEC-20240115-004', name: 'Spec 4', description: '', stage: 'complete', createdAt: new Date(), updatedAt: new Date(), completedAt: new Date(), requirements: [], testFiles: [], implementationFiles: [], metadata: { author: '', project: '', tags: [] } },
      ];
      
      for (const spec of specs) {
        await tracker.addSpec(spec);
      }
      
      const state = await tracker.readState();
      expect(state?.metrics.byStage.spec).toBe(2);
      expect(state?.metrics.byStage.test).toBe(1);
      expect(state?.metrics.byStage.code).toBe(0);
      expect(state?.metrics.byStage.qa).toBe(0);
      expect(state?.metrics.byStage.complete).toBe(1);
      expect(state?.metrics.byStage.archived).toBe(0);
    });

    it('should calculate completion rate correctly', async () => {
      await tracker.initialize('Completion Test');
      
      const specs: Spec[] = [
        { id: 'SPEC-20240115-001', name: 'Spec 1', description: '', stage: 'spec', createdAt: new Date(), updatedAt: new Date(), requirements: [], testFiles: [], implementationFiles: [], metadata: { author: '', project: '', tags: [] } },
        { id: 'SPEC-20240115-002', name: 'Spec 2', description: '', stage: 'complete', createdAt: new Date(), updatedAt: new Date(), completedAt: new Date(), requirements: [], testFiles: [], implementationFiles: [], metadata: { author: '', project: '', tags: [] } },
        { id: 'SPEC-20240115-003', name: 'Spec 3', description: '', stage: 'complete', createdAt: new Date(), updatedAt: new Date(), completedAt: new Date(), requirements: [], testFiles: [], implementationFiles: [], metadata: { author: '', project: '', tags: [] } },
      ];
      
      for (const spec of specs) {
        await tracker.addSpec(spec);
      }
      
      const state = await tracker.readState();
      expect(state?.metrics.completionRate).toBe(2 / 3);
    });

    it('should calculate average cycle time correctly', async () => {
      await tracker.initialize('Cycle Time Test');
      
      const createdAt1 = new Date('2024-01-01');
      const completedAt1 = new Date('2024-01-05'); // 4 days
      
      const createdAt2 = new Date('2024-01-10');
      const completedAt2 = new Date('2024-01-13'); // 3 days
      
      const specs: Spec[] = [
        { 
          id: 'SPEC-20240115-001', 
          name: 'Spec 1', 
          description: '', 
          stage: 'complete', 
          createdAt: createdAt1, 
          updatedAt: completedAt1, 
          completedAt: completedAt1,
          requirements: [], 
          testFiles: [], 
          implementationFiles: [], 
          metadata: { author: '', project: '', tags: [] } 
        },
        { 
          id: 'SPEC-20240115-002', 
          name: 'Spec 2', 
          description: '', 
          stage: 'complete', 
          createdAt: createdAt2, 
          updatedAt: completedAt2, 
          completedAt: completedAt2,
          requirements: [], 
          testFiles: [], 
          implementationFiles: [], 
          metadata: { author: '', project: '', tags: [] } 
        },
      ];
      
      for (const spec of specs) {
        await tracker.addSpec(spec);
      }
      
      // Read the raw file content to verify metrics were calculated correctly
      // Note: createdAt/completedAt are not stored in markdown, so cycle time
      // is only accurate immediately after writing, before round-trip
      const content = await readFile(join(tempDir, 'PROJECT_STATE.md'), 'utf-8');
      
      // Verify the markdown shows the cycle time at write time
      expect(content).toContain('Avg Cycle Time');
      expect(content).toContain('days');
      // Cycle time should be greater than 0 for completed specs
      expect(content).toMatch(/Avg Cycle Time.*[1-9]\.\d days/);
    });
  });
});
